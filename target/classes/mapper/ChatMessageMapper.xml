<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ChatMessageMapper">
    <resultMap id="BaseResultMap" type="com.example.demo.pojo.entity.ChatMessage">
        <id column="message_id" property="messageId"/>
        <result column="sender_id" property="senderId"/>
        <result column="receiver_id" property="receiverId"/>
        <result column="content" property="content"/>
        <result column="msg_type" property="msgType"/>
        <result column="is_read" property="isRead"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="messageId">
        insert into chat_messages(sender_id, receiver_id, content, msg_type, is_read, create_time)
        values(#{senderId}, #{receiverId}, #{content}, #{msgType}, 0, now())
    </insert>

    <select id="listHistory" resultMap="BaseResultMap">
        select * from chat_messages
        where (sender_id = #{userId1} and receiver_id = #{userId2})
           or (sender_id = #{userId2} and receiver_id = #{userId1})
        order by create_time asc
    </select>

    <update id="markRead">
        update chat_messages set is_read = 1
        where sender_id = #{senderId} and receiver_id = #{receiverId} and is_read = 0
    </update>
</mapper>
