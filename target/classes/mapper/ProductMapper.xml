<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ProductMapper">

    <resultMap id="BaseResultMap" type="com.example.demo.pojo.entity.Product">
        <id column="product_id" property="productId"/>
        <result column="seller_id" property="sellerId"/>
        <result column="category_id" property="categoryId"/>
        <result column="product_name" property="productName"/>
        <result column="description" property="description"/>
        <result column="price" property="price"/>
        <result column="original_price" property="originalPrice"/>
        <result column="stock" property="stock"/>
        <result column="sales_count" property="salesCount"/>
        <result column="main_image" property="mainImage"/>
        <result column="images" property="images"/>
        <result column="shipping_address" property="shippingAddress"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="productId" keyColumn="product_id">
        insert into products(
            seller_id, category_id, product_name, description,
            price, original_price, stock, sales_count,
            main_image, images, shipping_address, status, create_time, update_time
        ) values (
            #{sellerId}, #{categoryId}, #{productName}, #{description},
            #{price}, #{originalPrice}, #{stock}, #{salesCount},
            #{mainImage}, #{images}, #{shippingAddress}, #{status}, now(), now()
        )
    </insert>

    <update id="update">
        update products
        set category_id = #{categoryId},
            product_name = #{productName},
            description = #{description},
            price = #{price},
            original_price = #{originalPrice},
            stock = #{stock},
            main_image = #{mainImage},
            images = #{images},
            shipping_address = #{shippingAddress},
            status = #{status},
            update_time = now()
        where product_id = #{productId}
    </update>

    <update id="updateStatus">
        update products set status = #{status}, update_time = now() where product_id = #{productId}
    </update>

    <update id="updateStock">
        update products
        <set>
            <if test="delta != null">
                stock = stock + #{delta},
            </if>
            <if test="stock != null">
                stock = #{stock},
            </if>
            update_time = now()
        </set>
        where product_id = #{productId}
    </update>

    <select id="findById" resultMap="BaseResultMap">
        select * from products where product_id = #{productId}
    </select>

    <select id="search" resultMap="BaseResultMap">
        select * from products
        <where>
            <if test="categoryId != null"> category_id = #{categoryId} </if>
            <if test="keyword != null and keyword != ''">
                and (product_name like concat('%', #{keyword}, '%') or description like concat('%', #{keyword}, '%'))
            </if>
            <if test="minPrice != null and minPrice != ''">
                and price &gt;= #{minPrice}
            </if>
            <if test="maxPrice != null and maxPrice != ''">
                and price &lt;= #{maxPrice}
            </if>
            <if test="status != null"> and status = #{status} </if>
            <if test="sellerId != null"> and seller_id = #{sellerId} </if>
        </where>
        <choose>
            <when test="sortBy != null and sortBy != ''">
                order by
                <choose>
                    <when test="sortBy == 'price'"> price </when>
                    <when test="sortBy == 'sales'"> sales_count </when>
                    <otherwise> create_time </otherwise>
                </choose>
                <choose>
                    <when test="order != null and order.toLowerCase() == 'asc'"> asc </when>
                    <otherwise> desc </otherwise>
                </choose>
            </when>
            <otherwise>
                order by create_time desc
            </otherwise>
        </choose>
    </select>

</mapper>
