<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ProductOrderMapper">

    <resultMap id="BaseResultMap" type="com.example.demo.pojo.entity.ProductOrder">
        <id column="order_id" property="orderId"/>
        <result column="order_no" property="orderNo"/>
        <result column="user_id" property="userId"/>
        <result column="seller_id" property="sellerId"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="delivery_address" property="deliveryAddress"/>
        <result column="contact_name" property="contactName"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="order_status" property="orderStatus"/>
        <result column="pay_time" property="payTime"/>
        <result column="ship_time" property="shipTime"/>
        <result column="confirm_time" property="confirmTime"/>
        <result column="cancel_reason" property="cancelReason"/>
        <result column="remark" property="remark"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="orderId" keyColumn="order_id">
        insert into product_orders(
            order_no, user_id, seller_id, total_amount, delivery_address,
            contact_name, contact_phone, order_status, remark, created_at, updated_at
        ) values(
            #{orderNo}, #{userId}, #{sellerId}, #{totalAmount}, #{deliveryAddress},
            #{contactName}, #{contactPhone}, #{orderStatus}, #{remark}, now(), now()
        )
    </insert>

    <update id="updateStatus">
        update product_orders
        set order_status = #{orderStatus},
            cancel_reason = #{cancelReason},
            updated_at = now()
        where order_no = #{orderNo}
    </update>

    <update id="markPay">
        update product_orders
        set order_status = 2,
            pay_time = now(),
            updated_at = now()
        where order_no = #{orderNo} and order_status = 1
    </update>

    <update id="markShip">
        update product_orders
        set order_status = 3,
            ship_time = now(),
            updated_at = now()
        where order_no = #{orderNo} and order_status = 2
    </update>

    <update id="markConfirm">
        update product_orders
        set order_status = 4,
            confirm_time = now(),
            updated_at = now()
        where order_no = #{orderNo} and order_status = 3
    </update>

    <select id="findByOrderNo" resultMap="BaseResultMap">
        select * from product_orders where order_no = #{orderNo}
    </select>

    <select id="listByUser" resultMap="BaseResultMap">
        select * from product_orders
        <where>
            user_id = #{userId}
            <if test="status != null"> and order_status = #{status} </if>
        </where>
        order by created_at desc
    </select>

    <select id="listBySeller" resultMap="BaseResultMap">
        select * from product_orders
        <where>
            seller_id = #{sellerId}
            <if test="status != null"> and order_status = #{status} </if>
        </where>
        order by created_at desc
    </select>

</mapper>
